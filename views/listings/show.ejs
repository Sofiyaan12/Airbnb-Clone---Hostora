<% layout("/layouts/boilerplate.ejs") %>

<div class="row mt-3">
  <div class="col-md-8 offset-md-2">
    <h1 class="mb-4"><%= listing.title %></h1>

    <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="img-fluid rounded mb-4">

    <h3 class="text-success">â‚¹ <%= listing.price.toLocaleString() %> / Night</h3>
    <p class="text-muted">Location: <%= listing.location %>, <%= listing.country %></p>
    <p><%= listing.description %></p>

    <div class="mt-5">
      <h4>Map View</h4>
      <% if (listing.geometry && listing.geometry.coordinates) { %>
        <div id="map" style="height: 400px; border-radius: 12px;"></div>
        <script>
          mapboxgl.accessToken = '<%= process.env.MAPBOX_TOKEN %>';
          const map = new mapboxgl.Map({
              container: 'map',
              style: 'mapbox://styles/mapbox/streets-v12',
              center: <%- JSON.stringify(listing.geometry.coordinates) %>,
              zoom: 9
          });

          new mapboxgl.Marker()
              .setLngLat(<%- JSON.stringify(listing.geometry.coordinates) %>)
              .addTo(map);
        </script>
      <% } else { %>
        <div class="alert alert-warning mt-3">Map data not available for this listing.</div>
      <% } %>
    </div>

    <hr>
    <% if (currentUser && currentUser._id.equals(listing.owner._id)) { %>
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-warning">Edit</a>
      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" style="display: inline-block;">
        <button class="btn btn-outline-danger">Delete</button>
      </form>
    <% } %>
  </div>
</div>

<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
